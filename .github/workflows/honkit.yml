name: Build & Deploy Honkit

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Honkit
        run: npm install -g honkit

      - name: Generate honkit/src from source docs
        run: |
          chmod +x scripts/build_honkit.sh
          ./scripts/build_honkit.sh

      - name: Build HTML
        run: |
          cd honkit
          honkit build

      - name: Inject Cloudflare Analytics
        run: |
          find honkit/_book -name "*.html" -print0 | \
          xargs -0 perl -0777 -i -pe "
            next if /static\.cloudflareinsights\.com\/beacon\.min\.js/i;
            s!(</head>)!<script defer src=\"https://static.cloudflareinsights.com/beacon.min.js\" data-cf-beacon='{\"token\":\"378b5380e98f41e6b068752c8e3d5255\"}'></script>\n\$1!ig
          "
    
      - name: Inject GitHub source links
        env:
          BASE_URL: https://github.com/human-attunement/system/blob/main
        run: |
          find honkit/_book -name "*.html" -print0 | \
          xargs -0 perl -0777 -i -pe '
            my $base = $ENV{BASE_URL} // "";
        
            # Honkitが埋めている "file":{"path":"..."} を抜く（これが真実）
            my $md = "";
            if (/"file"\s*:\s*\{\s*"path"\s*:\s*"([^"]+?)"/s) {
              $md = $1;
            }
        
            # 念のためフォールバック（取れなかったときだけ）
            if ($md eq "") {
              my $path = $ARGV;
              $path =~ s!.*/_book/!!;
              $path =~ s!index\.html$!README.md!;
              $path =~ s!\.html$!.md!;
              $md = $path;
            }
        
            my $href = "$base/$md";
            my $link = qq{
              <div class="source-link" style="margin:2rem 0;padding-top:1rem;border-top:1px solid #eee;font-size:0.9em;color:#666">
                <a href="$href" target="_blank" rel="noopener">View source on GitHub</a>
              </div>
            };
        
            # 二重注入防止（任意だけど現場では必須）
            s!<div class="source-link".*?</div>!!sg;
      
            s!(</body>)!$link\n$1!i;
          '      
      - name: Inject source link styles
        run: |
          find honkit/_book -name "*.html" -print0 | \
          xargs -0 perl -0777 -i -pe '
            s!(</head>)!<style>
              .source-link a { color:#888; text-decoration:none; }
              .source-link a:hover { text-decoration:underline; }
            </style>\n$1!i;
          '
      - name: Disable Jekyll
        run: |
          touch honkit/_book/.nojekyll
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: honkit/_book
          cname: docs.human-attunement.org